var I=Object.defineProperty;var x=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var j=(s,e,i)=>e in s?I(s,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[e]=i,g=(s,e)=>{for(var i in e||(e={}))z.call(e,i)&&j(s,i,e[i]);if(x)for(var i of x(e))G.call(e,i)&&j(s,i,e[i]);return s};import{b as F,u as H,c as J}from"./index.aeeddaf6.js";import{e as v,r as K,o as B,w as Q,f as m,b as w,D as C,C as u,d as y,g as p,c as W,F as X,h as b,t as N,u as r,j as c,v as V,A,a as Y}from"./vendor.3c5bca8b.js";const Z={class:"row"},ee=b(" Modifier "),te=b(" Annuler "),ie=b(" Supprimer "),se={class:"col-4 position-relative"},ae=["src"],ne={__name:"AppTreeForm",props:{families:{required:!0,type:Object},fields:F(),id:{required:!0,type:String},machine:{required:!0,type:Object}},setup(s){const e=s,i=v(()=>[{label:"Parent",name:"parent",options:e.families,type:"select"},...e.fields]),t=v(()=>e.families.selected),a=v(()=>{var l,o;return(o=(l=t.value)==null?void 0:l.form(i.value))!=null?o:{file:"/img/no-image.png"}}),n=v(()=>{var l,o;return(o=(l=t.value)==null?void 0:l.fullName)!=null?o:"Ajouter une famille"}),d=K(null),f=v(()=>`${e.id}-create`);function $(){e.machine.send("submit"),e.families.blur(),e.machine.send("success")}async function D(){t.value&&await t.value.remove()}async function L(l){e.machine.send("submit");try{t.value?await t.value.update(e.fields,l):await e.families.create(e.fields,l),e.machine.send("success")}catch(o){e.machine.send("fail",{violations:o})}}function S(){d.value=g({},a.value)}return S(),B(S),Q(a,S),(l,o)=>{const _=m("AppBtn"),M=m("AppForm"),R=m("AppCard");return w(),C(R,{id:s.id,title:r(n)},{default:u(()=>[y("div",Z,[p(M,{id:r(f),modelValue:d.value,"onUpdate:modelValue":o[0]||(o[0]=h=>d.value=h),disabled:s.machine.state.value.matches("loading"),fields:r(i),"no-ignore-null":s.families.hasSelected,violations:s.machine.state.value.context.violations,class:"col","label-cols":"col-xl-3 col-lg-12","submit-label":"Cr\xE9er",onSubmit:L},{default:u(({disabled:h,form:q,submitLabel:U,type:O})=>[s.families.hasSelected?(w(),W(X,{key:0},[p(_,{disabled:h,form:q,type:O,class:"me-2"},{default:u(()=>[ee]),_:2},1032,["disabled","form","type"]),p(_,{disabled:h,class:"me-2",variant:"warning",onClick:$},{default:u(()=>[te]),_:2},1032,["disabled"]),p(_,{disabled:h,variant:"danger",onClick:D},{default:u(()=>[ie]),_:2},1032,["disabled"])],64)):(w(),C(_,{key:1,disabled:h,form:q,type:O},{default:u(()=>[b(N(U),1)]),_:2},1032,["disabled","form","type"]))]),_:1},8,["id","modelValue","disabled","fields","no-ignore-null","violations"]),y("div",se,[y("img",{src:d.value.file,class:"img-thumbnail position-absolute start-50 top-50 translate-middle"},null,8,ae)])])]),_:1},8,["id","title"])}}};function P(s){return c(m("AppTreeLabel"),{item:s.item,machine:s.machine},()=>c(m("Fa"),{class:"me-1",icon:`chevron-${s.item.opened?"up":"down"}`}))}P.props={item:{required:!0,type:Object},machine:{required:!0,type:Object}};function T(s){const e=[c(s.item.hasChildren?P:m("AppTreeLabel"),{class:"pointer",item:s.item,machine:s.machine})];if(s.item.opened)for(const i of s.item.children)e.push(c(T,{class:"ms-4",item:i,key:i["@id"],machine:s.machine}));return c("div",e)}T.props={item:{required:!0,type:Object},machine:{required:!0,type:Object}};function E(s){return c("div",{class:"row",id:s.id},[c("div",{class:"col-lg-4 col-md-6 col-sm-12"},s.items.map(e=>c(T,{item:e,key:e["@id"],machine:s.machine}))),c(ne,{class:"col",families:s.families,fields:s.fields,id:`${s.id}-form`,machine:s.machine})])}E.props={families:{required:!0,type:Object},fields:F(),id:{required:!0,type:String},items:{required:!0,type:Array},machine:{required:!0,type:Object}};function k(s,e,i){return V(`${s}/${e.id}`,{actions:{blur(){this.opened=!1,this.selected=!1},dispose(){this.$reset(),this.$dispose()},focus(){this.root.blur(),this.selected=!0,this.open()},open(){var t;this.opened=!0,(t=this.parentStore)==null||t.open()},async remove(){await new A().fetch(this.iri,"DELETE"),this.root.remove(this["@id"]),this.dispose()},async update(t,a){const n=await new A(t).fetch(this.iri,"POST",a,!1);if(n.status===422)throw n.content.violations;this.$state=g({opened:this.opened,root:this.root,selected:this.selected},n.content)}},getters:{children:t=>t.root.findByParent(t["@id"]).sort((a,n)=>a.name.localeCompare(n.name)),form:t=>a=>{var d;const n={};for(const f of a)n[f.name]=t[f.name];return n.file=(d=t.filepath)!=null?d:"/img/no-image.png",n},fullName(t){return this.parentStore?`${this.parentStore.fullName}\\${t.name}`:t.name},hasChildren(){return this.children.length>0},iri:t=>`/api/${t.iriType}/${t.id}`,isRoot:t=>!t.parent,option:t=>({text:t.fullName,value:t["@id"]}),parentStore:t=>t.root.find(t.parent)},state:()=>g({iriType:s,opened:!1,root:i,selected:!1},e)})()}function oe(s){return V(s,{actions:{blur(){for(const e of this.items)e.blur()},async create(e,i){const t=await new A(e).fetch(this.iri,"POST",i,!1);if(t.status===422)throw t.content.violations;this.items.push(k(this.iriType,t.content,this))},dispose(){this.$reset();for(const e of this.items)e.dispose();this.$dispose()},async fetch(){const e=await new A().fetch(this.iri);if(e.status===200)for(const i of e.content["hydra:member"])this.items.push(k(this.iriType,i,this))},remove(e){this.items=this.items.filter(i=>i["@id"]!==e)}},getters:{find:e=>i=>e.items.find(t=>t["@id"]===i),findByParent:e=>i=>{const t=[];for(const a of e.items)a.parent===i&&t.push(a);return t},hasSelected(){return Boolean(this.selected)},iri:e=>`/api/${e.iriType}`,options:e=>e.items.map(i=>i.option).sort((i,t)=>i.text.localeCompare(t.text)),roots:e=>e.items.filter(i=>i.isRoot).sort((i,t)=>i.name.localeCompare(t.name)),selected:e=>e.items.find(i=>i.selected)},state:()=>({iriType:s,items:[]})})()}const le={class:"row"},re={class:"col"},ue={__name:"AppTreePage",props:{fields:F(),label:{required:!0,type:String}},setup(s){const e=H(),i=oe(e.name),t=J(e.name),a=`${e.name}-tree`;return B(async()=>{await i.fetch(),t.send("success")}),Y(()=>{i.dispose()}),(n,d)=>{const f=m("Fa"),$=m("AppOverlay");return w(),C($,{id:r(e).name,spinner:r(t).state.value.matches("loading")},{default:u(()=>[y("div",le,[y("h1",re,[p(f,{icon:"layer-group"}),b(" Familles de "+N(s.label),1)])]),p(r(E),{id:a,families:r(i),fields:s.fields,items:r(i).roots,machine:r(t)},null,8,["families","fields","items","machine"])]),_:1},8,["id","spinner"])}}};export{ue as default};
